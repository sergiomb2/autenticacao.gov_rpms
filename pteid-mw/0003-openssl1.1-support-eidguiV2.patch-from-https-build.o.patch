From 45562c196997f14cdb14c8d6ddfb0c646c6ca2f5 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?S=C3=A9rgio=20M=2E=20Basto?= <sergio@serjux.com>
Date: Sun, 2 Jun 2019 05:53:39 +0100
Subject: [PATCH 3/8] openssl1.1-support-eidguiV2.patch from
 https://build.opensuse.org/package/show/home:emberez/pteid-mw

---
 eidguiV2/pdfsignatureclient.cpp | 11 ++++++-----
 1 file changed, 6 insertions(+), 5 deletions(-)

diff --git a/eidguiV2/pdfsignatureclient.cpp b/eidguiV2/pdfsignatureclient.cpp
index 4c8a233..eea97a7 100644
--- a/eidguiV2/pdfsignatureclient.cpp
+++ b/eidguiV2/pdfsignatureclient.cpp
@@ -52,16 +52,17 @@ ns1__AttributeType *convertAttributeType(ns3__AttributeType *, soap *);
 unsigned int SHA256_Wrapper(unsigned char *data, unsigned long data_len, unsigned char *digest)
 {
 
-    EVP_MD_CTX cmd_ctx;
+    EVP_MD_CTX *cmd_ctx = EVP_MD_CTX_new();
     unsigned int md_len = 0;
 
     //Calculate the hash from the data
-    EVP_DigestInit(&cmd_ctx, EVP_sha256());
-    EVP_DigestUpdate(&cmd_ctx, data, data_len);
-    EVP_DigestFinal(&cmd_ctx, digest, &md_len);
+    EVP_DigestInit(cmd_ctx, EVP_sha256());
+    EVP_DigestUpdate(cmd_ctx, data, data_len);
+    EVP_DigestFinal(cmd_ctx, digest, &md_len);
 
-    return md_len;
+    EVP_MD_CTX_free(cmd_ctx);
 
+    return md_len;
 }
 
 void loadPkcs7Object(QByteArray &sigBinary, SignatureDetails &sigDetails)
-- 
2.21.0

